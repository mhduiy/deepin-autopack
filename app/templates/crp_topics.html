{% extends "base.html" %}

{% block title %}CRP主题管理{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0">
            <i class="bi bi-archive"></i> CRP主题管理
        </h2>
        <button class="btn btn-primary" onclick="refreshTopics()">
            <i class="bi bi-arrow-clockwise"></i> 刷新
        </button>
    </div>

    <!-- 加载提示 -->
    <div id="loading" class="text-center py-5" style="display: none;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">加载中...</span>
        </div>
        <p class="mt-3 text-muted">正在加载主题列表...</p>
    </div>

    <!-- 错误提示 -->
    <div id="error-alert" class="alert alert-danger" role="alert" style="display: none;">
        <i class="bi bi-exclamation-triangle-fill"></i>
        <span id="error-message"></span>
    </div>

    <!-- 主题列表 -->
    <div id="topics-container" class="row g-4">
        <!-- 主题卡片将在这里动态生成 -->
    </div>

    <!-- 空状态 -->
    <div id="empty-state" class="text-center py-5" style="display: none;">
        <i class="bi bi-inbox" style="font-size: 4rem; color: #ccc;"></i>
        <p class="mt-3 text-muted">暂无主题</p>
        <p class="text-muted">请先在全局配置中设置CRP分支ID</p>
        <a href="/config" class="btn btn-primary mt-2">
            <i class="bi bi-gear"></i> 前往配置
        </a>
    </div>
</div>

<style>
.topic-card {
    transition: all 0.3s ease;
    border: 1px solid #dee2e6;
    border-radius: 0.5rem;
    overflow: hidden;
}

.topic-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    border-color: #0d6efd;
}

.topic-card-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 1.5rem;
}

.topic-card-body {
    padding: 1.5rem;
}

.topic-id {
    font-size: 0.875rem;
    opacity: 0.9;
}

.topic-name {
    font-size: 1.25rem;
    font-weight: 600;
    margin: 0;
}

.btn-enter-topic {
    width: 100%;
    padding: 0.75rem;
    font-weight: 500;
}
</style>

<script>
// 页面加载时获取主题列表
document.addEventListener('DOMContentLoaded', function() {
    loadTopics();
});

async function loadTopics() {
    const loading = document.getElementById('loading');
    const error = document.getElementById('error-alert');
    const container = document.getElementById('topics-container');
    const emptyState = document.getElementById('empty-state');

    // 显示加载状态
    loading.style.display = 'block';
    error.style.display = 'none';
    container.innerHTML = '';
    emptyState.style.display = 'none';

    try {
        const response = await fetch('/api/topics');
        const result = await response.json();

        loading.style.display = 'none';

        if (!result.success) {
            showError(result.message);
            return;
        }

        const topics = result.data;

        if (!topics || topics.length === 0) {
            emptyState.style.display = 'block';
            return;
        }

        // 渲染主题卡片
        topics.forEach(topic => {
            const card = createTopicCard(topic);
            container.appendChild(card);
        });

    } catch (err) {
        loading.style.display = 'none';
        showError('加载主题列表失败: ' + err.message);
    }
}

function createTopicCard(topic) {
    const col = document.createElement('div');
    col.className = 'col-12 col-md-6 col-lg-4';

    col.innerHTML = `
        <div class="topic-card">
            <div class="topic-card-header">
                <div class="topic-id">ID: ${topic.ID}</div>
                <h5 class="topic-name">${topic.Name}</h5>
            </div>
            <div class="topic-card-body">
                <p class="text-muted mb-3">
                    <i class="bi bi-tag"></i> 类型: ${topic.TopicType || '-'}
                </p>
                <button class="btn btn-primary btn-enter-topic" onclick="enterTopic(${topic.ID}, '${topic.Name}')">
                    <i class="bi bi-box-arrow-in-right"></i> 查看详情
                </button>
            </div>
        </div>
    `;

    return col;
}

function enterTopic(topicId, topicName) {
    window.location.href = `/topics/${topicId}`;
}

function refreshTopics() {
    loadTopics();
}

function showError(message) {
    const error = document.getElementById('error-alert');
    const errorMessage = document.getElementById('error-message');
    errorMessage.textContent = message;
    error.style.display = 'block';
}
</script>
{% endblock %}
