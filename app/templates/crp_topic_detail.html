{% extends "base.html" %}

{% block title %}主题详情 - Deepin 自动打包工具{% endblock %}

{% block content %}
<!-- 主内容区域 -->
<div id="mainContent">
    <div class="mb-4">
        <a href="{{ url_for('crp.topics') }}" class="btn btn-outline-secondary btn-sm mb-3">
            <i class="bi bi-arrow-left"></i> 返回主题列表
        </a>
        
        <div class="topic-header" id="topicHeader">
            <!-- 加载中显示 -->
            <div class="loading-inline">
                <div class="spinner-border text-light me-2" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <span class="text-white">正在加载主题信息...</span>
            </div>
        </div>
    </div>

    <div id="releasesContainer">
        <!-- 加载中显示 -->
        <div class="text-center py-5 loading-inline">
            <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3 text-muted">正在加载包列表...</p>
        </div>
    </div>
</div>

<style>
.topic-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 16px;
    padding: 2rem;
    box-shadow: 0 4px 16px rgba(102, 126, 234, 0.3);
    margin-bottom: 2rem;
}

.topic-header-content h2 {
    color: white;
    font-weight: 700;
}

.topic-header-content p {
    color: rgba(255, 255, 255, 0.9);
    font-size: 1.1rem;
    margin-bottom: 0;
}

.topic-meta {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
}

.meta-badge {
    background: rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(10px);
    color: white;
    padding: 0.375rem 0.875rem;
    border-radius: 8px;
    font-size: 0.875rem;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
}

/* 现代化表格样式 */
.table-container {
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    overflow: hidden;
}

.modern-table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    font-size: 0.95rem;
}

.modern-table thead {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.modern-table thead th {
    padding: 1rem;
    text-align: left;
    font-weight: 600;
    font-size: 0.875rem;
    letter-spacing: 0.5px;
    border: none;
    white-space: nowrap;
}

.modern-table thead th i {
    margin-right: 0.5rem;
    opacity: 0.9;
}

.modern-table tbody tr {
    border-bottom: 1px solid #f0f0f0;
    transition: all 0.2s ease;
}

.modern-table tbody tr:hover {
    background: #f8f9fe;
    transform: scale(1.01);
    box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
}

.modern-table tbody tr:last-child {
    border-bottom: none;
}

.modern-table tbody td {
    padding: 1rem;
    vertical-align: middle;
    border: none;
}

.package-cell strong {
    color: #2c3e50;
    font-size: 1rem;
}

.package-cell small {
    font-size: 0.85rem;
    margin-top: 0.25rem;
}

.badge-modern {
    padding: 0.375rem 0.75rem;
    border-radius: 6px;
    font-weight: 500;
    font-size: 0.875rem;
    display: inline-block;
}

.badge-branch {
    background: #e3f2fd;
    color: #1976d2;
    border: 1px solid #bbdefb;
}

.badge-tag {
    background: #f3e5f5;
    color: #7b1fa2;
    border: 1px solid #e1bee7;
}

.badge-arch {
    background: #e8f5e9;
    color: #388e3c;
    border: 1px solid #c8e6c9;
}

/* 架构状态按钮 */
.arch-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 0.375rem;
}

.arch-btn {
    padding: 0.375rem 0.75rem;
    border-radius: 6px;
    font-size: 0.875rem;
    font-weight: 500;
    border: none;
    cursor: default;
    transition: all 0.2s ease;
    min-width: 70px;
    text-align: center;
    position: relative;
}

.arch-btn.loading {
    background: #e2e3e5;
    color: #6c757d;
}

.arch-btn.failed {
    background: linear-gradient(135deg, #ff6b6b, #ee5a6f);
    color: white;
    cursor: pointer;
}

.arch-btn.failed:hover {
    background: linear-gradient(135deg, #ff5252, #e64a64);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(238, 90, 111, 0.4);
}

.arch-btn.build-ok {
    background: linear-gradient(135deg, #10b981, #059669);
    color: white;
}

.arch-btn.building {
    background: linear-gradient(135deg, #3b82f6, #2563eb);
    color: white;
    animation: pulse 2s infinite;
}

.arch-btn.other {
    background: #f3f4f6;
    color: #6b7280;
    border: 1px solid #d1d5db;
}

@keyframes pulse {
    0%, 100% {
        opacity: 1;
    }
    50% {
        opacity: 0.7;
    }
}

.arch-btn[title] {
    cursor: help;
}

.arch-btn.failed[title] {
    cursor: pointer;
}

.commit-hash {
    background: #f5f5f5;
    color: #616161;
    padding: 0.375rem 0.625rem;
    border-radius: 6px;
    font-family: 'Courier New', monospace;
    font-size: 0.875rem;
    border: 1px solid #e0e0e0;
}

.status-badge {
    padding: 0.5rem 0.875rem;
    border-radius: 8px;
    font-weight: 600;
    font-size: 0.875rem;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    white-space: nowrap;
}

.status-success {
    background: #d1e7dd;
    color: #0f5132;
    border: 1px solid #badbcc;
}

.status-failed {
    background: #f8d7da;
    color: #842029;
    border: 1px solid #f5c2c7;
}

.status-building {
    background: #cfe2ff;
    color: #084298;
    border: 1px solid #b6d4fe;
}

.status-pending {
    background: #fff3cd;
    color: #856404;
    border: 1px solid #ffecb5;
}

.status-unknown {
    background: #e2e3e5;
    color: #41464b;
    border: 1px solid #d3d3d4;
}

.btn-group {
    display: inline-flex;
    gap: 0.25rem;
}

.btn-info-modern {
    background: linear-gradient(135deg, #3b82f6, #2563eb);
    color: white;
    border: none;
    padding: 0.5rem 0.875rem;
    border-radius: 6px;
    transition: all 0.2s ease;
    font-weight: 500;
}

.btn-info-modern:hover {
    background: linear-gradient(135deg, #2563eb, #1d4ed8);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
    color: white;
}

.btn-warning-modern {
    background: linear-gradient(135deg, #f59e0b, #d97706);
    color: white;
    border: none;
    padding: 0.5rem 0.875rem;
    border-radius: 6px;
    transition: all 0.2s ease;
    font-weight: 500;
}

.btn-warning-modern:hover {
    background: linear-gradient(135deg, #d97706, #b45309);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(217, 119, 6, 0.3);
    color: white;
}

.btn-danger-modern {
    background: linear-gradient(135deg, #ff6b6b, #ee5a6f);
    color: white;
    border: none;
    padding: 0.5rem 0.875rem;
    border-radius: 6px;
    transition: all 0.2s ease;
    font-weight: 500;
}

.btn-danger-modern:hover {
    background: linear-gradient(135deg, #ff5252, #e64a64);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(238, 90, 111, 0.3);
    color: white;
}

.spinner-border-sm {
    width: 0.875rem;
    height: 0.875rem;
    border-width: 0.15em;
}

.loading-inline {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 1rem;
}

/* 仓库地址显示区域 */
.repo-urls-section {
    background: rgba(255, 255, 255, 0.15);
    backdrop-filter: blur(10px);
    border-radius: 12px;
    padding: 1.25rem;
    margin-top: 1.5rem;
}

.repo-urls-section h5 {
    color: white;
    font-size: 0.95rem;
    font-weight: 600;
    margin-bottom: 0.75rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.repo-urls-textarea {
    width: 100%;
    background: rgba(255, 255, 255, 0.95);
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 8px;
    padding: 0.75rem;
    font-family: 'Courier New', monospace;
    font-size: 0.875rem;
    color: #2c3e50;
    resize: vertical;
    min-height: 80px;
    line-height: 1.6;
}

.repo-actions {
    display: flex;
    gap: 0.5rem;
    margin-top: 0.75rem;
}

.btn-copy-repo {
    background: rgba(255, 255, 255, 0.9);
    color: #667eea;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 6px;
    font-size: 0.875rem;
    font-weight: 500;
    transition: all 0.2s ease;
    cursor: pointer;
}

.btn-copy-repo:hover {
    background: white;
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
}

.btn-workflow {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    color: white;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 6px;
    font-size: 0.875rem;
    font-weight: 500;
    transition: all 0.2s ease;
    cursor: pointer;
}

.btn-workflow:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(245, 87, 108, 0.4);
}

.loading-repos {
    color: rgba(255, 255, 255, 0.8);
    font-size: 0.875rem;
    padding: 0.5rem;
}

/* 响应式优化 */
@media (max-width: 1200px) {
    .modern-table {
        font-size: 0.875rem;
    }
    
    .modern-table thead th,
    .modern-table tbody td {
        padding: 0.75rem;
    }
}

@media (max-width: 768px) {
    .table-container {
        overflow-x: auto;
    }
    
    .modern-table {
        min-width: 800px;
    }
}
</style>

<script>
// 从URL获取topic_id
const topicId = {{ topic_id }};

// 页面加载时获取数据
document.addEventListener('DOMContentLoaded', function() {
    loadTopicDetail();
});

// 加载主题详情
async function loadTopicDetail() {
    try {
        const response = await fetch(`/api/topics/${topicId}/detail`);
        const result = await response.json();
        
        if (result.success && result.data) {
            renderTopicHeader(result.data.topic);
            renderReleases(result.data.releases);
        } else {
            throw new Error(result.message || '加载数据失败');
        }
    } catch (error) {
        console.error('加载主题详情失败:', error);
        document.getElementById('topicHeader').innerHTML = `
            <div class="text-center py-3">
                <i class="bi bi-exclamation-circle text-white" style="font-size: 3rem;"></i>
                <p class="text-white mt-2">加载失败: ${error.message}</p>
            </div>
        `;
        document.getElementById('releasesContainer').innerHTML = `
            <div class="text-center py-5">
                <i class="bi bi-exclamation-circle text-danger" style="font-size: 4rem;"></i>
                <p class="mt-3 text-muted">加载失败: ${error.message}</p>
                <button class="btn btn-primary" onclick="location.reload()">
                    <i class="bi bi-arrow-clockwise me-1"></i>重新加载
                </button>
            </div>
        `;
    }
}

// 渲染主题头部信息
function renderTopicHeader(topic) {
    const headerHTML = `
        <div class="topic-header-content">
            <h2 class="mb-2">
                <i class="bi bi-layers-fill text-white me-2"></i>${topic.name}
            </h2>
            <p class="text-white-50 mb-3">${topic.description || '无描述'}</p>
            <div class="topic-meta">
                <span class="meta-badge">
                    <i class="bi bi-calendar3"></i> ${topic.create_time}
                </span>
                <span class="meta-badge">
                    <i class="bi bi-person-fill"></i> ${topic.creator_name}
                </span>
            </div>
            
            <!-- 仓库地址显示区域 -->
            <div class="repo-urls-section" id="repoUrlsSection">
                <h5>
                    <i class="bi bi-box-seam"></i>
                    仓库地址
                </h5>
                <div class="loading-repos">
                    <span class="spinner-border spinner-border-sm me-2"></span>
                    正在加载仓库地址...
                </div>
            </div>
        </div>
    `;
    document.getElementById('topicHeader').innerHTML = headerHTML;
    
    // 加载仓库地址
    loadRepoUrls(topic.id);
}

// 加载仓库地址
async function loadRepoUrls(topicId) {
    const section = document.getElementById('repoUrlsSection');
    
    try {
        // 首先获取配置中的branchID
        const configResponse = await fetch('/config/api/config');
        const configResult = await configResponse.json();
        
        if (!configResult.success || !configResult.data.crp_branch_id) {
            throw new Error('未配置CRP分支ID，请先在配置页面设置');
        }
        
        const branchID = configResult.data.crp_branch_id;
        
        // 调用CRP API获取仓库地址
        const response = await fetch('https://crp.uniontech.com/api/topic_urls', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                branchID: branchID,
                topicID: topicId
            })
        });
        
        const data = await response.json();
        
        if (data.RepoUrls && data.RepoUrls.length > 0) {
            // 格式化仓库地址：每个地址添加前缀和后缀
            const formattedUrls = data.RepoUrls.map(url => 
                `deb [trusted=yes] ${url} unstable main`
            ).join('\n');
            
            section.innerHTML = `
                <h5>
                    <i class="bi bi-box-seam"></i>
                    仓库地址
                </h5>
                <textarea class="repo-urls-textarea" readonly>${formattedUrls}</textarea>
                <div class="repo-actions">
                    <button class="btn-copy-repo" onclick="copyRepoUrls()">
                        <i class="bi bi-clipboard"></i> 复制仓库地址
                    </button>
                    <button class="btn-workflow" onclick="enterWorkflow()" title="功能开发中">
                        <i class="bi bi-arrow-right-circle"></i> 进入CRP工作流
                    </button>
                </div>
            `;
        } else {
            section.innerHTML = `
                <h5>
                    <i class="bi bi-box-seam"></i>
                    仓库地址
                </h5>
                <div style="color: rgba(255, 255, 255, 0.8); font-size: 0.875rem;">
                    <i class="bi bi-info-circle me-1"></i>
                    暂无仓库地址
                </div>
                <div class="repo-actions" style="margin-top: 0.75rem;">
                    <button class="btn-workflow" onclick="enterWorkflow()" title="功能开发中">
                        <i class="bi bi-arrow-right-circle"></i> 进入CRP工作流
                    </button>
                </div>
            `;
        }
    } catch (error) {
        console.error('加载仓库地址失败:', error);
        section.innerHTML = `
            <h5>
                <i class="bi bi-box-seam"></i>
                仓库地址
            </h5>
            <div style="color: rgba(255, 255, 255, 0.8); font-size: 0.875rem;">
                <i class="bi bi-exclamation-triangle me-1"></i>
                ${error.message}
            </div>
            <div class="repo-actions" style="margin-top: 0.75rem;">
                <button class="btn-workflow" onclick="enterWorkflow()" title="功能开发中">
                    <i class="bi bi-arrow-right-circle"></i> 进入CRP工作流
                </button>
            </div>
        `;
    }
}

// 复制仓库地址到剪贴板
function copyRepoUrls() {
    const textarea = document.querySelector('.repo-urls-textarea');
    if (textarea) {
        textarea.select();
        document.execCommand('copy');
        showToast('仓库地址已复制到剪贴板', 'success');
    }
}

// 进入CRP工作流
function enterWorkflow() {
    window.open(`https://crp.uniontech.com/#/workflow/workflow?id=${topicId}`, '_blank');
}

// 加载架构状态
async function loadArchStatus(buildId) {
    const container = document.getElementById(`arch-${buildId}`);
    if (!container) return;
    
    try {
        const response = await fetch('https://shuttle.uniontech.com/api/shuttle/task/list', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                params: { taskid: buildId.toString() },
                pageSize: 20,
                current: 1
            })
        });
        
        const data = await response.json();
        
        if (data.tasks && data.tasks.length > 0 && data.tasks[0].jobs) {
            const jobs = data.tasks[0].jobs;
            let buttonsHTML = '';
            
            jobs.forEach(job => {
                const status = job.status || 'UNKNOWN';
                let btnClass = 'other';
                let clickable = false;
                
                if (status === 'FAILED') {
                    btnClass = 'failed';
                    clickable = true;
                } else if (status === 'BUILD_OK' || status === 'UPLOAD_OK') {
                    btnClass = 'build-ok';
                } else if (status.includes('BUILD') && !status.includes('OK')) {
                    btnClass = 'building';
                }
                
                const onclick = clickable ? `onclick="retryArchBuild(${job.id}, '${job.arch}', ${buildId})"` : '';
                buttonsHTML += `
                    <button class="arch-btn ${btnClass}" 
                            title="${job.arch}: ${status}" 
                            ${onclick}>
                        ${job.arch}
                    </button>
                `;
            });
            
            container.innerHTML = buttonsHTML;
        } else {
            container.innerHTML = '<span class="badge-modern badge-arch">无架构信息</span>';
        }
    } catch (error) {
        console.error('加载架构状态失败:', error);
        container.innerHTML = '<span class="badge-modern badge-arch">加载失败</span>';
    }
}

// 重试架构构建
async function retryArchBuild(jobId, arch, buildId) {
    const confirmed = await customConfirm(
        `确定要重试 ${arch} 架构的构建吗？`,
        '重试架构构建',
        'arrow-clockwise',
        'warning'
    );
    
    if (!confirmed) return;
    
    try {
        // 获取维护者姓名作为username
        const configResponse = await fetch('/config/api/config');
        const configResult = await configResponse.json();
        
        if (!configResult.success || !configResult.data.maintainer_name) {
            showToast('未配置维护者姓名，请先在配置页面设置', 'error');
            return;
        }
        
        const username = configResult.data.maintainer_name;
        
        const response = await fetch('https://shuttle.uniontech.com/api/shuttle/job/rebuild', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                jobid: jobId,
                username: username
            })
        });
        
        const data = await response.json();
        
        if (data.code === 0) {
            showToast(`${arch} 架构重试成功`, 'success');
            // 重新加载架构状态
            setTimeout(() => {
                loadArchStatus(buildId);
            }, 1000);
        } else {
            showToast(`重试失败: ${data.message}`, 'error');
        }
    } catch (error) {
        console.error('重试架构构建失败:', error);
        showToast(`重试失败: ${error.message}`, 'error');
    }
}

// 渲染包列表
function renderReleases(releases) {
    const container = document.getElementById('releasesContainer');
    
    if (!releases || releases.length === 0) {
        container.innerHTML = `
            <div class="text-center py-5">
                <i class="bi bi-inbox" style="font-size: 4rem; color: #ccc;"></i>
                <p class="mt-3 text-muted">该主题下暂无包</p>
            </div>
        `;
        return;
    }
    
    let tableHTML = `
        <div class="table-container">
            <table class="modern-table">
                <thead>
                    <tr>
                        <th><i class="bi bi-box-seam"></i> 包名</th>
                        <th><i class="bi bi-diagram-3"></i> 分支</th>
                        <th><i class="bi bi-tag"></i> 标签</th>
                        <th><i class="bi bi-hash"></i> Commit</th>
                        <th><i class="bi bi-cpu"></i> 架构</th>
                        <th><i class="bi bi-activity"></i> 构建状态</th>
                        <th class="text-center"><i class="bi bi-gear"></i> 操作</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    releases.forEach(release => {
        const buildStateHTML = getStatusBadge(release.build_state);
        const commitHash = release.commit ? release.commit.substring(0, 10) : 'N/A';
        
        tableHTML += `
            <tr>
                <td>
                    <div class="package-cell">
                        <strong>${release.project_name}</strong>
                        ${release.project_name !== release.source_pkg_name ? `
                        <small class="text-muted d-block">
                            <i class="bi bi-arrow-return-right"></i> ${release.source_pkg_name}
                        </small>
                        ` : ''}
                    </div>
                </td>
                <td>
                    <span class="badge-modern badge-branch">${release.branch}</span>
                </td>
                <td>
                    <span class="badge-modern badge-tag">${release.tag}</span>
                </td>
                <td>
                    <code class="commit-hash">${commitHash}</code>
                </td>
                <td>
                    <div class="arch-buttons" id="arch-${release.build_id}" data-build-state="${release.build_state}">
                        ${release.build_state === 'UPLOAD_OK' 
                            ? '<span class="arch-btn build-ok" title="所有架构已完成">✓ 已完成</span>' 
                            : '<span class="arch-btn loading"><span class="spinner-border spinner-border-sm"></span> 加载中</span>'
                        }
                    </div>
                </td>
                <td>
                    ${buildStateHTML}
                </td>
                <td class="text-center">
                    <div class="btn-group" role="group">
                        <button class="btn btn-sm btn-info-modern" 
                                onclick="viewDetails(${release.build_id})"
                                title="查看详情">
                            <i class="bi bi-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-warning-modern" 
                                onclick="retryBuild(${release.id}, '${release.project_name}')"
                                title="重试构建">
                            <i class="bi bi-arrow-clockwise"></i>
                        </button>
                        <button class="btn btn-sm btn-danger-modern" 
                                onclick="abandonRelease(${release.id}, '${release.project_name}')"
                                title="放弃打包">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    });
    
    tableHTML += `
                </tbody>
            </table>
        </div>
    `;
    
    container.innerHTML = tableHTML;
    
    // 加载每个release的架构状态
    releases.forEach(release => {
        // 如果构建状态是UPLOAD_OK，不需要调用API，已经显示完成状态
        if (release.build_state === 'UPLOAD_OK') {
            return;
        }
        
        if (release.build_id && release.build_id !== 0) {
            loadArchStatus(release.build_id);
        } else {
            // 没有build_id，显示原始架构信息
            const archContainer = document.getElementById(`arch-${release.build_id}`);
            if (archContainer) {
                archContainer.innerHTML = `<span class="badge-modern badge-arch">${release.arches}</span>`;
            }
        }
    });
}

// 根据构建状态返回对应的HTML
function getStatusBadge(buildState) {
    const statusMap = {
        'SUCCESS': '<span class="status-badge status-success"><i class="bi bi-check-circle-fill"></i> 成功</span>',
        'FAILED': '<span class="status-badge status-failed"><i class="bi bi-x-circle-fill"></i> 失败</span>',
        'BUILDING': '<span class="status-badge status-building"><span class="spinner-border spinner-border-sm me-1"></span> 构建中</span>',
        'PENDING': '<span class="status-badge status-pending"><i class="bi bi-clock-fill"></i> 待构建</span>'
    };
    
    return statusMap[buildState] || `<span class="status-badge status-unknown"><i class="bi bi-question-circle-fill"></i> ${buildState}</span>`;
}

// 查看构建详情
function viewDetails(buildId) {
    if (!buildId || buildId === 0) {
        alert('该包尚未开始构建');
        return;
    }
    window.open(`https://shuttle.uniontech.com/#/tasks/task?taskid=${buildId}`, '_blank');
}

// 重试构建
function retryBuild(releaseId, projectName) {
    if (!confirm(`确定要重试构建 ${projectName} 吗？`)) {
        return;
    }
    
    fetch(`/crp/api/releases/${releaseId}/retry`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('已触发重新构建');
            location.reload();
        } else {
            alert('操作失败: ' + data.message);
        }
    })
    .catch(err => {
        alert('请求失败: ' + err);
    });
}

// 放弃打包
function abandonRelease(releaseId, projectName) {
    if (!confirm(`确定要放弃打包 ${projectName} 吗？`)) {
        return;
    }
    
    fetch(`/crp/api/releases/${releaseId}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('操作失败: ' + data.message);
        }
    })
    .catch(err => {
        alert('请求失败: ' + err);
    });
}
</script>
{% endblock %}
