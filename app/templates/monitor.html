{% extends "base.html" %}

{% block title %}提交监控 - Deepin 自动打包工具{% endblock %}

{% block content %}
<!-- 主内容区域 -->
<div id="mainContent">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0">
            <i class="bi bi-activity text-primary me-2"></i>提交监控
        </h2>
        <button class="btn btn-primary" onclick="refreshAllProjects()">
            <i class="bi bi-arrow-clockwise me-1"></i>刷新所有项目
        </button>
    </div>

    <div id="projectsContainer">
        <!-- 加载中显示 -->
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3 text-muted">正在加载监控数据...</p>
        </div>
    </div>
</div>

<!-- 打包配置模态框 (保持不变) -->
<div class="modal fade" id="packageModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-gradient-primary">
                <h5 class="modal-title text-white">
                    <i class="bi bi-box-seam me-2"></i>
                    <span id="modalProjectName"></span> - 打包配置
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- 版本信息 -->
                <div class="section-card mb-3">
                    <div class="section-header">
                        <i class="bi bi-tag-fill me-2"></i>版本信息
                    </div>
                    <div class="section-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label small text-muted">当前版本</label>
                                <div class="version-display" id="currentVersionDisplay">-</div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small text-muted">
                                    新版本号
                                    <i class="bi bi-info-circle-fill text-info ms-1" 
                                       data-bs-toggle="tooltip" 
                                       title="自动递增最后一位，可手动修改"></i>
                                </label>
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i class="bi bi-arrow-up-circle"></i>
                                    </span>
                                    <input type="text" class="form-control" id="newVersion" placeholder="输入新版本号">
                                    <button class="btn btn-outline-secondary" type="button" onclick="autoIncrementVersion()">
                                        <i class="bi bi-plus-circle me-1"></i>自动+1
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 分支和提交信息 -->
                <div class="section-card mb-3">
                    <div class="section-header" style="justify-content: space-between;">
                        <div>
                            <i class="bi bi-git me-2"></i>分支和提交信息
                        </div>
                        <code class="commit-hash-header" id="commitHash">-</code>
                    </div>
                    <div class="section-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="branch-info-item">
                                    <i class="bi bi-github text-dark me-2"></i>
                                    <span class="branch-label">GitHub:</span>
                                    <code class="branch-value" id="githubBranch">-</code>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="branch-info-item">
                                    <i class="bi bi-code-square text-primary me-2"></i>
                                    <span class="branch-label">Gerrit:</span>
                                    <code class="branch-value" id="gerritBranch">-</code>
                                </div>
                            </div>
                        </div>
                        <hr class="my-3">
                        <div class="commit-info-box">
                            <div class="commit-message-box" id="commitMessage">
                                暂无提交信息
                            </div>
                            <small class="text-muted d-block mt-2">
                                <i class="bi bi-info-circle me-1"></i>
                                将从这个提交开始打包
                            </small>
                        </div>
                    </div>
                </div>

                <!-- CRP主题选择 -->
                <div class="section-card mb-3" id="crpTopicSection">
                    <div class="section-header">
                        <i class="bi bi-collection me-2"></i>CRP主题
                    </div>
                    <div class="section-body">
                        <select class="form-select" id="crpTopic">
                            <option value="">选择CRP主题（暂未加载）</option>
                        </select>
                        <small class="form-text text-muted mt-2 d-block">
                            <i class="bi bi-info-circle me-1"></i>
                            后续将从CRP平台获取主题列表
                        </small>
                    </div>
                </div>

                <!-- 架构选择 -->
                <div class="section-card mb-3" id="archSection">
                    <div class="section-header" style="justify-content: space-between;">
                        <div>
                            <i class="bi bi-cpu me-2"></i>目标架构
                        </div>
                        <div class="arch-header-actions">
                            <button class="btn btn-sm btn-outline-primary" onclick="selectAllArchs()" style="font-size: 0.75rem; padding: 0.25rem 0.5rem;">
                                <i class="bi bi-check2-all me-1"></i>全选
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="clearAllArchs()" style="font-size: 0.75rem; padding: 0.25rem 0.5rem;">
                                <i class="bi bi-x-circle me-1"></i>清空
                            </button>
                        </div>
                    </div>
                    <div class="section-body">
                        <div class="arch-selector">
                            <div class="form-check form-check-inline arch-checkbox">
                                <input class="form-check-input" type="checkbox" id="arch-amd64" value="amd64" checked>
                                <label class="form-check-label" for="arch-amd64">
                                    <i class="bi bi-pc-display me-1"></i>amd64
                                </label>
                            </div>
                            <div class="form-check form-check-inline arch-checkbox">
                                <input class="form-check-input" type="checkbox" id="arch-arm64" value="arm64" checked>
                                <label class="form-check-label" for="arch-arm64">
                                    <i class="bi bi-phone me-1"></i>arm64
                                </label>
                            </div>
                            <div class="form-check form-check-inline arch-checkbox">
                                <input class="form-check-input" type="checkbox" id="arch-loong64" value="loong64" checked>
                                <label class="form-check-label" for="arch-loong64">
                                    <i class="bi bi-cpu me-1"></i>loong64
                                </label>
                            </div>
                            <div class="form-check form-check-inline arch-checkbox">
                                <input class="form-check-input" type="checkbox" id="arch-sw64" value="sw64" checked>
                                <label class="form-check-label" for="arch-sw64">
                                    <i class="bi bi-cpu me-1"></i>sw64
                                </label>
                            </div>
                            <div class="form-check form-check-inline arch-checkbox">
                                <input class="form-check-input" type="checkbox" id="arch-mips64el" value="mips64el" checked>
                                <label class="form-check-label" for="arch-mips64el">
                                    <i class="bi bi-cpu me-1"></i>mips64el
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 打包模式选择 -->
                <div class="section-card mb-3">
                    <div class="section-header">
                        <i class="bi bi-sliders me-2"></i>打包模式
                    </div>
                    <div class="section-body">
                        <div class="mode-radio-group">
                            <div class="form-check mode-radio-item">
                                <input class="form-check-input" type="radio" name="packageMode" id="modeNormal" value="normal" checked onchange="togglePackageMode()">
                                <label class="form-check-label" for="modeNormal">
                                    <div class="mode-label-content">
                                        <div class="mode-title">
                                            <i class="bi bi-box-seam me-2"></i>
                                            <strong>正常打包</strong>
                                        </div>
                                        <small class="text-muted d-block mt-1">
                                            提交 changelog 并进行 CRP 打包
                                        </small>
                                    </div>
                                </label>
                            </div>
                            <div class="form-check mode-radio-item">
                                <input class="form-check-input" type="radio" name="packageMode" id="modeChangelogOnly" value="changelog" onchange="togglePackageMode()">
                                <label class="form-check-label" for="modeChangelogOnly">
                                    <div class="mode-label-content">
                                        <div class="mode-title">
                                            <i class="bi bi-file-text me-2"></i>
                                            <strong>仅提交 Changelog</strong>
                                        </div>
                                        <small class="text-muted d-block mt-1">
                                            只更新项目的 changelog 文件，不进行 CRP 打包
                                        </small>
                                    </div>
                                </label>
                            </div>
                            <div class="form-check mode-radio-item">
                                <input class="form-check-input" type="radio" name="packageMode" id="modeCrpOnly" value="crp" onchange="togglePackageMode()">
                                <label class="form-check-label" for="modeCrpOnly">
                                    <div class="mode-label-content">
                                        <div class="mode-title">
                                            <i class="bi bi-rocket-takeoff me-2"></i>
                                            <strong>仅 CRP 打包</strong>
                                        </div>
                                        <small class="text-muted d-block mt-1">
                                            不提交 changelog，直接使用现有版本进行 CRP 打包
                                        </small>
                                    </div>
                                </label>
                            </div>
                        </div>
                        <div class="alert alert-info mt-3 mb-0" id="modeHintChangelog" style="display: none;">
                            <i class="bi bi-info-circle me-2"></i>
                            <span>Changelog 模式下无需选择架构和 CRP 主题</span>
                        </div>
                        <div class="alert alert-warning mt-3 mb-0" id="modeHintCrp" style="display: none;">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            <span>仅 CRP 打包模式将使用现有 changelog 中的版本号，无需填写新版本</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-1"></i>取消
                </button>
                <button type="button" class="btn btn-primary" id="submitPackageBtn" onclick="submitPackageTask()">
                    <i class="bi bi-send me-1"></i>提交打包任务
                </button>
            </div>
        </div>
    </div>
</div>

<style>
/* 现代化表格样式 */
.table-container {
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    overflow: hidden;
}

.modern-table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    font-size: 0.95rem;
}

.modern-table thead {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.modern-table thead th {
    padding: 1rem;
    text-align: left;
    font-weight: 600;
    font-size: 0.875rem;
    letter-spacing: 0.5px;
    border: none;
    white-space: nowrap;
}

.modern-table thead th i {
    margin-right: 0.5rem;
    opacity: 0.9;
}

.modern-table tbody tr:not(.collapse-row) {
    border-bottom: 1px solid #f0f0f0;
    transition: all 0.2s ease;
}

.modern-table tbody tr:not(.collapse-row):hover {
    background: #f8f9fe;
    transform: scale(1.002);
    box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
}

.modern-table tbody td {
    padding: 1rem;
    vertical-align: middle;
    border: none;
}

.project-name-cell strong {
    color: #2c3e50;
    font-size: 1rem;
}

.version-badge {
    color: #667eea;
    font-weight: 600;
}

.tag-badge {
    color: #f5576c;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
}

.commit-count-cell {
    display: flex;
    flex-direction: row;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
}

.count-badge-table {
    display: inline-block;
    padding: 0.25rem 0.625rem;
    border-radius: 6px;
    font-weight: 500;
    font-size: 0.95rem;
    min-width: 36px;
    text-align: center;
}

.count-has-table {
    background: #e7f3ff;
    color: #1976d2;
    border: 1px solid #bbdefb;
}

.count-zero-table {
    color: #9e9e9e;
    background: #f5f5f5;
    border: 1px solid #e0e0e0;
}

.btn-view-commits {
    background: #e7f3ff;
    border: 1px solid #bbdefb;
    color: #1976d2;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.875rem;
    cursor: pointer;
    transition: all 0.2s ease;
    margin-top: 0.25rem;
}

.btn-view-commits:hover {
    background: #bbdefb;
    transform: translateY(-1px);
}

.commit-info-cell {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
}

.commit-msg-inline {
    color: #2c3e50;
    font-size: 0.875rem;
    display: block;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    max-width: 300px;
}

.commit-date-inline {
    color: #6c757d;
    font-size: 0.75rem;
}

.btn-group {
    display: inline-flex;
    gap: 0.25rem;
}

.btn-refresh-table {
    background: linear-gradient(135deg, #3b82f6, #2563eb);
    color: white;
    border: none;
    padding: 0.5rem 0.75rem;
    border-radius: 6px;
    transition: all 0.2s ease;
    font-weight: 500;
}

.btn-refresh-table:hover:not(:disabled) {
    background: linear-gradient(135deg, #2563eb, #1d4ed8);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
    color: white;
}

.btn-package-table {
    background: linear-gradient(135deg, #10b981, #059669);
    color: white;
    border: none;
    padding: 0.5rem 0.75rem;
    border-radius: 6px;
    transition: all 0.2s ease;
    font-weight: 500;
}

.btn-package-table:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

/* 折叠内容样式 */
.collapse-row {
    border: none !important;
}

.collapse-row:hover {
    background: transparent !important;
}

.commits-collapse-content {
    background: #f8f9fe;
    border-top: 2px solid #667eea;
    border-bottom: 2px solid #f0f0f0;
    padding: 1rem 1.5rem;
}

.commits-list-compact {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    max-height: 400px;
    overflow-y: auto;
}

.commit-item-compact {
    background: white;
    border-left: 3px solid #667eea;
    padding: 0.75rem;
    border-radius: 6px;
    display: grid;
    grid-template-columns: auto 1fr;
    gap: 0.75rem;
    align-items: start;
}

.commit-hash-link {
    text-decoration: none;
    display: inline-block;
    transition: transform 0.2s ease;
}

.commit-hash-link:hover {
    transform: translateY(-2px);
}

.commit-hash-compact {
    background: #2c3e50;
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-family: 'Courier New', monospace;
    font-size: 0.75rem;
    white-space: nowrap;
    transition: background 0.2s ease;
}

.commit-hash-link:hover .commit-hash-compact {
    background: #667eea;
}

.commit-message-compact {
    color: #2c3e50;
    font-size: 0.95rem;
    grid-column: 2;
}

.commit-meta-compact {
    grid-column: 2;
    display: flex;
    gap: 1.5rem;
    font-size: 0.875rem;
    color: #6c757d;
    align-items: center;
}

.commit-meta-compact span {
    display: flex;
    align-items: center;
    gap: 0.25rem;
}

.commit-view-link {
    color: #667eea;
    text-decoration: none;
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 0.25rem;
    transition: color 0.2s ease;
}

.commit-view-link:hover {
    color: #764ba2;
    text-decoration: underline;
}

.spinner-border-sm {
    width: 0.875rem;
    height: 0.875rem;
    border-width: 0.15em;
}

.bg-gradient-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.section-card {
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    overflow: hidden;
}

.section-header {
    background: #f8f9fa;
    padding: 0.75rem 1rem;
    font-weight: 600;
    color: #495057;
    border-bottom: 1px solid #e0e0e0;
    display: flex;
    align-items: center;
}

.section-body {
    padding: 0.875rem 1rem;
}

.version-display {
    background: #e7f3ff;
    border: 1px solid #bbdefb;
    border-radius: 6px;
    padding: 0.5rem 0.75rem;
    color: #1976d2;
    font-weight: 600;
    font-size: 1.1rem;
}

.branch-info-item {
    display: flex;
    align-items: center;
    padding: 0.5rem;
    background: #f8f9fa;
    border-radius: 6px;
}

.branch-label {
    font-weight: 500;
    color: #6c757d;
    margin-right: 0.5rem;
}

.branch-value {
    background: #2c3e50;
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.875rem;
}

.commit-hash-header {
    background: #2c3e50;
    color: white;
    padding: 0.375rem 0.75rem;
    border-radius: 4px;
    font-size: 0.8rem;
    font-family: 'Courier New', monospace;
}

.commit-info-box {
    background: #f8f9fa;
    border-radius: 6px;
    padding: 1rem;
}

.commit-message-box {
    color: #495057;
    line-height: 1.6;
    font-size: 0.95rem;
}

.arch-selector {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
}

.arch-header-actions {
    display: flex;
    gap: 0.5rem;
}

.arch-checkbox {
    margin: 0;
    flex: 0 0 auto;
}

.arch-checkbox .form-check-input {
    width: 1.25rem;
    height: 1.25rem;
    margin-top: 0.125rem;
}

.arch-checkbox .form-check-label {
    font-weight: 500;
    color: #495057;
    cursor: pointer;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    transition: all 0.2s ease;
}

.arch-checkbox .form-check-input:checked + .form-check-label {
    background: #e7f3ff;
    color: #1976d2;
}

.arch-select-all {
    display: flex;
    gap: 0.5rem;
}

.mode-radio-group {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.mode-radio-item {
    padding: 0.75rem 1rem;
    background: #f8f9fa;
    border-radius: 8px;
    border: 2px solid #e0e0e0;
    transition: all 0.3s ease;
    margin: 0;
}

.mode-radio-item:has(input:checked) {
    background: #e7f3ff;
    border-color: #1976d2;
}

.mode-radio-item .form-check-input {
    display: none;
}

.mode-radio-item .form-check-label {
    cursor: pointer;
    margin-left: 0;
    flex: 1;
    width: 100%;
}

.mode-label-content {
    flex: 1;
}

.mode-title {
    display: flex;
    align-items: center;
    color: #2c3e50;
    font-size: 0.95rem;
    margin-bottom: 0.25rem;
}

.mode-radio-item:has(input:checked) .mode-title {
    color: #1976d2;
}

/* 响应式优化 */
@media (max-width: 1200px) {
    .modern-table {
        font-size: 0.875rem;
    }
    
    .modern-table thead th,
    .modern-table tbody td {
        padding: 0.75rem;
    }
}

@media (max-width: 768px) {
    .table-container {
        overflow-x: auto;
    }
    
    .modern-table {
        min-width: 900px;
    }
}
</style>

<script>
// 页面加载时获取数据
document.addEventListener('DOMContentLoaded', function() {
    loadMonitorData();
});

// 加载监控数据
async function loadMonitorData() {
    try {
        // 使用并行版本的API，性能更好
        const response = await fetch('/api/monitor/data-parallel');
        const result = await response.json();
        
        if (result.success && result.data) {
            renderProjects(result.data);
        } else {
            throw new Error(result.message || '加载数据失败');
        }
    } catch (error) {
        console.error('加载监控数据失败:', error);
        document.getElementById('projectsContainer').innerHTML = `
            <div class="text-center py-5">
                <i class="bi bi-exclamation-circle text-danger" style="font-size: 4rem;"></i>
                <div class="mt-3 text-danger fw-bold">加载失败</div>
                <div class="mt-2 text-muted">${error.message}</div>
                <button class="btn btn-primary mt-3" onclick="location.reload()">
                    <i class="bi bi-arrow-clockwise me-1"></i>重新加载
                </button>
            </div>
        `;
    }
}

// 渲染项目列表
function renderProjects(projects) {
    const container = document.getElementById('projectsContainer');
    
    if (!projects || projects.length === 0) {
        container.innerHTML = `
            <div class="text-center py-5">
                <i class="bi bi-inbox display-1 text-muted"></i>
                <h4 class="mt-3 text-muted">暂无就绪的项目</h4>
                <p class="text-muted">请先在项目列表中克隆仓库</p>
                <a href="/projects" class="btn btn-primary mt-3">
                    <i class="bi bi-arrow-left me-1"></i>返回项目列表
                </a>
            </div>
        `;
        return;
    }
    
    let tableHTML = `
        <div class="table-container">
            <table class="modern-table">
                <thead>
                    <tr>
                        <th><i class="bi bi-folder2-open"></i> 项目名</th>
                        <th><i class="bi bi-tag-fill"></i> 当前版本</th>
                        <th class="text-center"><i class="bi bi-plus-circle-fill"></i> 新增提交</th>
                        <th><i class="bi bi-hash"></i> 最新Commit</th>
                        <th class="text-center"><i class="bi bi-gear"></i> 操作</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    projects.forEach(projectInfo => {
        const project = projectInfo.project;
        const currentVersion = projectInfo.current_version || '';
        const newCommitsCount = projectInfo.new_commits_count || 0;
        const newCommits = projectInfo.new_commits || [];
        const latestCommit = projectInfo.latest_commit;
        
        tableHTML += `
            <tr>
                <td>
                    <div class="project-name-cell">
                        <strong>${project.name}</strong>
                    </div>
                </td>
                <td>
                    <span class="version-badge" id="version-${project.id}">
                        ${currentVersion || '<span class="text-muted">未知</span>'}
                    </span>
                </td>
                <td class="text-center">
                    <div class="commit-count-cell">
                        <span id="commit-count-${project.id}">
                            ${newCommitsCount > 0 
                                ? `<span class="count-badge-table count-has-table">${newCommitsCount}</span>` 
                                : '<span class="count-badge-table count-zero-table">0</span>'}
                        </span>
                        ${newCommits.length > 0 ? `
                        <button class="btn-view-commits" 
                                type="button" 
                                data-bs-toggle="collapse" 
                                data-bs-target="#commits-${project.id}"
                                title="展开查看提交列表">
                            展开
                        </button>
                        ` : ''}
                    </div>
                </td>
                <td>
                    <div class="commit-info-cell" id="latest-commit-${project.id}">
                        ${latestCommit ? `
                            <span class="commit-msg-inline">${latestCommit.message}</span>
                            <small class="commit-date-inline">${latestCommit.date}</small>
                        ` : '<span class="text-muted">-</span>'}
                    </div>
                </td>
                <td class="text-center">
                    <div class="btn-group" role="group">
                        <button class="btn btn-sm btn-refresh-table" 
                                onclick="refreshProject(${project.id})"
                                id="refresh-btn-${project.id}"
                                title="刷新项目">
                            <i class="bi bi-arrow-clockwise"></i>
                        </button>
                        <button class="btn btn-sm btn-package-table" 
                                data-project-id="${project.id}"
                                data-project-name="${project.name}"
                                data-current-version="${currentVersion}"
                                data-github-branch="${project.github_branch}"
                                data-gerrit-branch="${project.gerrit_branch}"
                                data-commit-hash="${latestCommit ? latestCommit.hash : ''}"
                                data-commit-message="${latestCommit ? latestCommit.message : ''}"
                                onclick="openPackageModalFromButton(this)"
                                title="打包">
                            <i class="bi bi-box-seam"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
        
        if (newCommits.length > 0) {
            // 构建 GitHub 提交链接
            const githubUrl = project.github_url || '';
            const githubBaseUrl = githubUrl.replace(/\.git$/, '');
            
            tableHTML += `
                <tr class="collapse-row">
                    <td colspan="5" class="p-0">
                        <div class="collapse" id="commits-${project.id}">
                            <div class="commits-collapse-content">
                                <div class="commits-list-compact">
            `;
            
            newCommits.forEach(commit => {
                const commitUrl = `${githubBaseUrl}/commit/${commit.full_hash}`;
                tableHTML += `
                    <div class="commit-item-compact">
                        <a href="${commitUrl}" target="_blank" class="commit-hash-link" title="在 GitHub 上查看">
                            <code class="commit-hash-compact">${commit.hash}</code>
                        </a>
                        <span class="commit-message-compact">${commit.message}</span>
                        <div class="commit-meta-compact">
                            <span><i class="bi bi-person"></i> ${commit.author}</span>
                            <span><i class="bi bi-clock"></i> ${commit.date}</span>
                            <a href="${commitUrl}" target="_blank" class="commit-view-link">
                                <i class="bi bi-box-arrow-up-right"></i> 查看详情
                            </a>
                        </div>
                    </div>
                `;
            });
            
            tableHTML += `
                                </div>
                            </div>
                        </div>
                    </td>
                </tr>
            `;
        }
    });
    
    tableHTML += `
                </tbody>
            </table>
        </div>
    `;
    
    container.innerHTML = tableHTML;
}

// 打开打包配置模态框
let currentProjectData = {};

// 从按钮的 data 属性安全地获取数据
function openPackageModalFromButton(button) {
    const projectId = parseInt(button.getAttribute('data-project-id'));
    const projectName = button.getAttribute('data-project-name');
    const currentVersion = button.getAttribute('data-current-version');
    const githubBranch = button.getAttribute('data-github-branch');
    const gerritBranch = button.getAttribute('data-gerrit-branch');
    const commitHash = button.getAttribute('data-commit-hash');
    const commitMessage = button.getAttribute('data-commit-message');
    
    openPackageModal(projectId, projectName, currentVersion, githubBranch, gerritBranch, commitHash, commitMessage);
}

function openPackageModal(projectId, projectName, currentVersion, githubBranch, gerritBranch, commitHash, commitMessage) {
    currentProjectData = {
        projectId,
        projectName,
        currentVersion,
        githubBranch,
        gerritBranch,
        commitHash,
        commitMessage
    };
    
    document.getElementById('modalProjectName').textContent = projectName;
    document.getElementById('currentVersionDisplay').textContent = currentVersion || '未知';
    
    if (currentVersion) {
        const newVersion = incrementVersion(currentVersion);
        document.getElementById('newVersion').value = newVersion;
    } else {
        document.getElementById('newVersion').value = '';
    }
    
    document.getElementById('githubBranch').textContent = githubBranch || '未配置';
    document.getElementById('gerritBranch').textContent = gerritBranch || '未配置';
    document.getElementById('commitHash').textContent = commitHash || '无提交';
    document.getElementById('commitMessage').textContent = commitMessage || '暂无提交信息';
    
    loadCRPTopics();
    
    const modal = new bootstrap.Modal(document.getElementById('packageModal'));
    modal.show();
}

// 加载CRP主题列表
async function loadCRPTopics() {
    const select = document.getElementById('crpTopic');
    select.disabled = true;
    select.innerHTML = '<option value="">正在加载主题...</option>';
    
    try {
        const response = await fetch('/api/topics');
        const result = await response.json();
        
        if (result.success && result.data && result.data.length > 0) {
            select.innerHTML = '<option value="">请选择CRP主题</option>';
            result.data.forEach(topic => {
                const option = document.createElement('option');
                option.value = topic.ID;
                option.textContent = `${topic.Name} (${topic.Type})`;
                option.dataset.topicName = topic.Name;
                select.appendChild(option);
            });
            
            // 默认选中最后一个主题
            if (result.data.length > 0) {
                const lastTopic = result.data[result.data.length - 1];
                select.value = lastTopic.ID;
            }
        } else {
            select.innerHTML = '<option value="">暂无可用主题</option>';
        }
    } catch (error) {
        console.error('加载CRP主题失败:', error);
        select.innerHTML = '<option value="">加载主题失败</option>';
    } finally {
        select.disabled = false;
    }
}

// 版本号自增逻辑
function incrementVersion(version) {
    if (!version) return '';
    const parts = version.split('.');
    if (parts.length > 0) {
        const lastPart = parts[parts.length - 1];
        const match = lastPart.match(/^(\d+)(.*)$/);
        if (match) {
            const num = parseInt(match[1]);
            const suffix = match[2];
            parts[parts.length - 1] = (num + 1) + suffix;
            return parts.join('.');
        }
    }
    return version;
}

// 切换打包模式
function togglePackageMode() {
    const selectedMode = document.querySelector('input[name="packageMode"]:checked').value;
    const modeHintChangelog = document.getElementById('modeHintChangelog');
    const modeHintCrp = document.getElementById('modeHintCrp');
    const archSection = document.getElementById('archSection');
    const crpSection = document.getElementById('crpTopicSection');
    const versionSection = document.querySelector('.section-card:first-child');
    
    modeHintChangelog.style.display = 'none';
    modeHintCrp.style.display = 'none';
    
    if (selectedMode === 'changelog') {
        modeHintChangelog.style.display = 'block';
        archSection.style.opacity = '0.5';
        archSection.style.pointerEvents = 'none';
        crpSection.style.opacity = '0.5';
        crpSection.style.pointerEvents = 'none';
        versionSection.style.opacity = '1';
        versionSection.style.pointerEvents = 'auto';
    } else if (selectedMode === 'crp') {
        modeHintCrp.style.display = 'block';
        archSection.style.opacity = '1';
        archSection.style.pointerEvents = 'auto';
        crpSection.style.opacity = '1';
        crpSection.style.pointerEvents = 'auto';
        versionSection.style.opacity = '0.5';
        versionSection.style.pointerEvents = 'none';
    } else {
        archSection.style.opacity = '1';
        archSection.style.pointerEvents = 'auto';
        crpSection.style.opacity = '1';
        crpSection.style.pointerEvents = 'auto';
        versionSection.style.opacity = '1';
        versionSection.style.pointerEvents = 'auto';
    }
}

// 手动触发版本自增
function autoIncrementVersion() {
    const currentVersion = document.getElementById('currentVersionDisplay').textContent;
    if (currentVersion && currentVersion !== '未知' && currentVersion !== '-') {
        const newVersion = incrementVersion(currentVersion);
        document.getElementById('newVersion').value = newVersion;
    }
}

// 全选架构
function selectAllArchs() {
    document.querySelectorAll('.arch-checkbox input[type="checkbox"]').forEach(checkbox => {
        checkbox.checked = true;
    });
}

// 清空架构选择
function clearAllArchs() {
    document.querySelectorAll('.arch-checkbox input[type="checkbox"]').forEach(checkbox => {
        checkbox.checked = false;
    });
}

// 提交打包任务
function submitPackageTask() {
    const selectedMode = document.querySelector('input[name="packageMode"]:checked').value;
    const modeMap = {
        'normal': 'normal',
        'changelog': 'changelog_only',
        'crp': 'crp_only'
    };
    const packageMode = modeMap[selectedMode];
    const newVersion = document.getElementById('newVersion').value.trim();
    
    if (packageMode !== 'crp_only' && !newVersion) {
        showToast('请输入新版本号', 'warning');
        return;
    }
    
    const architectures = [];
    if (packageMode !== 'changelog_only') {
        document.querySelectorAll('.arch-checkbox input:checked').forEach(cb => {
            architectures.push(cb.value);
        });
        
        if (architectures.length === 0 && packageMode !== 'changelog_only') {
            showToast('请至少选择一个目标架构', 'warning');
            return;
        }
    }
    
    let crpTopicId = '';
    let crpTopicName = '';
    if (packageMode === 'normal' || packageMode === 'crp_only') {
        const topicSelect = document.getElementById('crpTopic');
        crpTopicId = topicSelect.value;
        const selectedOption = topicSelect.options[topicSelect.selectedIndex];
        crpTopicName = selectedOption ? selectedOption.dataset.topicName || selectedOption.textContent : '';
        
        if (!crpTopicId) {
            showToast('请选择CRP主题', 'warning');
            return;
        }
    }
    
    const requestData = {
        project_id: currentProjectData.projectId,
        mode: packageMode,
        version: newVersion,
        architectures: architectures,
        crp_topic_id: crpTopicId,
        crp_topic_name: crpTopicName,
        start_commit_hash: currentProjectData.commitHash || ''
    };
    
    const submitBtn = document.getElementById('submitPackageBtn');
    const originalText = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>提交中...';
    
    fetch('/api/tasks/create', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(requestData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const taskId = data.task_id;
            return fetch(`/api/tasks/${taskId}/start`, {
                method: 'POST'
            });
        } else {
            throw new Error(data.message || '创建任务失败');
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('可以在打包任务页面查看执行进度', 'success', '打包任务已成功创建并启动');
            const modal = bootstrap.Modal.getInstance(document.getElementById('packageModal'));
            modal.hide();
        } else {
            throw new Error(data.message || '启动任务失败');
        }
    })
    .catch(error => {
        showToast(error.message, 'error', '提交失败');
        console.error('提交打包任务失败:', error);
    })
    .finally(() => {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
    });
}

// 刷新单个项目
async function refreshProject(projectId) {
    const btn = document.getElementById(`refresh-btn-${projectId}`);
    const originalHtml = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>';
    
    try {
        const response = await fetch(`/monitor/projects/${projectId}/refresh`, {
            method: 'POST'
        });
        
        const result = await response.json();
        
        if (result.success) {
            if (result.data.current_version) {
                document.getElementById(`version-${projectId}`).innerHTML = result.data.current_version;
            }
            if (result.data.new_commits_count !== undefined) {
                const countEl = document.getElementById(`commit-count-${projectId}`);
                if (result.data.new_commits_count > 0) {
                    countEl.innerHTML = 
                        `<span class="count-badge-table count-has-table">${result.data.new_commits_count}</span>`;
                } else {
                    countEl.innerHTML = '<span class="count-badge-table count-zero-table">0</span>';
                }
            }
            if (result.data.latest_commit) {
                document.getElementById(`latest-commit-${projectId}`).innerHTML = 
                    `<span class="commit-msg-inline">${result.data.latest_commit.message}</span>` +
                    `<small class="commit-date-inline">${result.data.latest_commit.date}</small>`;
            }
            
            setTimeout(() => location.reload(), 500);
        } else {
            showToast(result.message, 'error', '刷新失败');
        }
    } catch (error) {
        console.error('刷新失败:', error);
        showToast(error.message, 'error', '刷新失败');
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalHtml;
    }
}

// 刷新所有项目
async function refreshAllProjects() {
    if (!confirm('确定要刷新所有项目吗？这可能需要一些时间。')) {
        return;
    }
    
    const btn = event.target;
    const originalHtml = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>刷新中...';
    
    try {
        const response = await fetch('/monitor/refresh-all', {
            method: 'POST'
        });
        
        const result = await response.json();
        
        if (result.success) {
            showToast(`成功: ${result.data.success_count}, 失败: ${result.data.failed_count}`, 'success', '刷新完成');
            location.reload();
        } else {
            showToast(result.message, 'error', '刷新失败');
        }
    } catch (error) {
        console.error('刷新失败:', error);
        showToast(error.message, 'error', '刷新失败');
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalHtml;
    }
}
</script>
{% endblock %}
