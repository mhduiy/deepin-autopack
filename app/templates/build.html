{% extends "base.html" %}

{% block title %}打包任务{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- 页面标题和操作按钮 -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0">
            <i class="bi bi-list-task"></i> 打包任务
        </h2>
        <div class="d-flex gap-2">
            <!-- 状态筛选 -->
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-outline-secondary btn-sm active" onclick="filterTasks('all')">
                    全部
                </button>
                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="filterTasks('running')">
                    <i class="bi bi-play-circle"></i> 进行中
                </button>
                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="filterTasks('success')">
                    <i class="bi bi-check-circle"></i> 成功
                </button>
                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="filterTasks('failed')">
                    <i class="bi bi-x-circle"></i> 失败
                </button>
            </div>
            
            <button class="btn btn-outline-danger" onclick="cleanupCompletedTasks()">
                <i class="bi bi-trash"></i> 清理已完成
            </button>
            
            <button class="btn btn-outline-primary" onclick="refreshTasks()">
                <i class="bi bi-arrow-clockwise"></i> 刷新
            </button>
        </div>
    </div>

    <!-- 任务统计 -->
    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="stat-card stat-total">
                <i class="bi bi-stack"></i>
                <div>
                    <div class="stat-value" id="stat-total">0</div>
                    <div class="stat-label">总任务</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card stat-running">
                <i class="bi bi-play-circle"></i>
                <div>
                    <div class="stat-value" id="stat-running">0</div>
                    <div class="stat-label">进行中</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card stat-success">
                <i class="bi bi-check-circle"></i>
                <div>
                    <div class="stat-value" id="stat-success">0</div>
                    <div class="stat-label">成功</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card stat-failed">
                <i class="bi bi-x-circle"></i>
                <div>
                    <div class="stat-value" id="stat-failed">0</div>
                    <div class="stat-label">失败</div>
                </div>
            </div>
        </div>
    </div>

    <!-- 加载提示 -->
    <div id="loading" class="text-center py-5" style="display: none;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">加载中...</span>
        </div>
        <p class="mt-3 text-muted">正在加载任务列表...</p>
    </div>

    <!-- 任务列表 -->
    <div id="tasks-container"></div>

    <!-- 空状态 -->
    <div id="empty-state" class="text-center py-5" style="display: none;">
        <i class="bi bi-inbox" style="font-size: 4rem; color: #ccc;"></i>
        <p class="mt-3 text-muted">暂无打包任务</p>
        <p class="text-muted small">打包任务会从提交监控页面创建</p>
    </div>
</div>

<!-- 任务详情模态框 -->
<div class="modal fade" id="taskDetailModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-info-circle me-2"></i>任务详情
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="taskDetailContent">
                <!-- 详情内容动态加载 -->
            </div>
        </div>
    </div>
</div>

<style>
/* 统计卡片 */
.stat-card {
    background: white;
    border-radius: 12px;
    padding: 1.25rem;
    display: flex;
    align-items: center;
    gap: 1rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    transition: all 0.3s ease;
}

.stat-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 16px rgba(0,0,0,0.12);
}

.stat-card i {
    font-size: 2.5rem;
    opacity: 0.9;
}

.stat-value {
    font-size: 2rem;
    font-weight: 700;
    line-height: 1;
    margin-bottom: 0.25rem;
}

.stat-label {
    font-size: 0.875rem;
    color: #666;
    font-weight: 500;
}

.stat-total i { color: #6c757d; }
.stat-total .stat-value { color: #6c757d; }

.stat-running i { color: #ffc107; }
.stat-running .stat-value { color: #ffc107; }

.stat-success i { color: #28a745; }
.stat-success .stat-value { color: #28a745; }

.stat-failed i { color: #dc3545; }
.stat-failed .stat-value { color: #dc3545; }

/* 任务卡片 */
.task-card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    margin-bottom: 1.5rem;
    overflow: hidden;
    transition: all 0.3s ease;
}

.task-card:hover {
    box-shadow: 0 4px 16px rgba(0,0,0,0.12);
    transform: translateY(-2px);
}

/* 任务头部 */
.task-header {
    padding: 1.25rem 1.5rem;
    background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
    border-bottom: 2px solid #f0f0f0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.task-title-section {
    display: flex;
    align-items: center;
    gap: 1rem;
    flex: 1;
}

.task-project-name {
    font-size: 1.25rem;
    font-weight: 600;
    color: #2c3e50;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.task-version {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.875rem;
    font-weight: 500;
}

.task-mode-badge {
    background: #e9ecef;
    color: #495057;
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 500;
}

.task-status-section {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.task-status-badge {
    padding: 0.5rem 1rem;
    border-radius: 8px;
    font-weight: 600;
    font-size: 0.875rem;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
}

.status-pending {
    background: #e9ecef;
    color: #495057;
}

.status-running {
    background: #fff3cd;
    color: #856404;
}

.status-success {
    background: #d1e7dd;
    color: #0f5132;
}

.status-failed {
    background: #f8d7da;
    color: #842029;
}

.status-paused {
    background: #d1ecf1;
    color: #0c5460;
}

.status-cancelled {
    background: #e2e3e5;
    color: #41464b;
}

/* 任务主体 */
.task-body {
    padding: 1.5rem;
}

/* 进度条 */
.task-progress-bar {
    height: 8px;
    background: #e9ecef;
    border-radius: 10px;
    overflow: hidden;
    margin-bottom: 1rem;
}

.task-progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
    transition: width 0.5s ease;
    position: relative;
    overflow: hidden;
}

.task-progress-fill::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    bottom: 0;
    right: 0;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
    animation: shimmer 2s infinite;
}

@keyframes shimmer {
    0% {
        transform: translateX(-100%);
    }
    100% {
        transform: translateX(100%);
    }
}

.task-progress-text {
    font-size: 0.875rem;
    color: #666;
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

/* 步骤网格 */
.steps-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 1.5rem;
}

.step-item {
    background: #f8f9fa;
    border: 2px solid #e9ecef;
    border-radius: 10px;
    padding: 1rem;
    transition: all 0.3s ease;
    position: relative;
}

.step-item.completed {
    background: linear-gradient(135deg, #d1e7dd 0%, #a3d9a5 100%);
    border-color: #28a745;
}

.step-item.running {
    background: linear-gradient(135deg, #fff3cd 0%, #ffe69c 100%);
    border-color: #ffc107;
    animation: pulseStep 2s infinite;
}

.step-item.failed {
    background: linear-gradient(135deg, #f8d7da 0%, #f1aeb5 100%);
    border-color: #dc3545;
}

.step-item.skipped {
    background: #f8f9fa;
    border-color: #dee2e6;
    opacity: 0.6;
}

@keyframes pulseStep {
    0%, 100% {
        box-shadow: 0 0 0 0 rgba(255, 193, 7, 0.4);
    }
    50% {
        box-shadow: 0 0 0 8px rgba(255, 193, 7, 0);
    }
}

.step-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0.5rem;
}

.step-icon {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.875rem;
    font-weight: bold;
    background: white;
    color: #999;
}

.step-item.completed .step-icon {
    background: #28a745;
    color: white;
}

.step-item.running .step-icon {
    background: #ffc107;
    color: white;
}

.step-item.failed .step-icon {
    background: #dc3545;
    color: white;
}

.step-name {
    font-weight: 600;
    font-size: 0.875rem;
    color: #2c3e50;
    flex: 1;
}

.step-time {
    font-size: 0.75rem;
    color: #666;
    margin-top: 0.25rem;
}

.step-log {
    font-size: 0.75rem;
    color: #666;
    margin-top: 0.5rem;
    padding: 0.5rem;
    background: rgba(255,255,255,0.5);
    border-radius: 6px;
    font-family: 'Courier New', monospace;
    white-space: pre-wrap;
    word-break: break-all;
}

.step-item.failed .step-log {
    background: rgba(220, 53, 69, 0.1);
    color: #842029;
    font-weight: 500;
}

/* 任务信息 */
.task-meta {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    padding: 1rem;
    background: #f8f9fa;
    border-radius: 8px;
    margin-bottom: 1rem;
}

.meta-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
    color: #666;
}

.meta-item i {
    color: #667eea;
    font-size: 1rem;
}

.meta-item strong {
    color: #2c3e50;
}

/* 错误信息 */
.error-message {
    background: linear-gradient(135deg, #f8d7da 0%, #f5c2c7 100%);
    border: 2px solid #dc3545;
    border-radius: 10px;
    padding: 1.25rem;
    margin-bottom: 1rem;
    display: flex;
    align-items: start;
    gap: 1rem;
}

.error-message i {
    font-size: 1.5rem;
    color: #dc3545;
    flex-shrink: 0;
}

.error-content {
    flex: 1;
}

.error-title {
    font-weight: 600;
    color: #842029;
    margin-bottom: 0.5rem;
    font-size: 1rem;
}

.error-text {
    color: #842029;
    font-size: 0.875rem;
    line-height: 1.5;
    font-family: 'Courier New', monospace;
    background: rgba(255,255,255,0.5);
    padding: 0.75rem;
    border-radius: 6px;
    margin-top: 0.5rem;
}

/* 任务操作按钮 */
.task-actions {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
    padding-top: 1rem;
    border-top: 1px solid #e9ecef;
}

.task-footer {
    padding: 1rem 1.5rem;
    background: #f8f9fa;
    border-top: 2px solid #e9ecef;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.task-timestamps {
    display: flex;
    gap: 1.5rem;
    font-size: 0.75rem;
    color: #666;
}

.timestamp-item {
    display: flex;
    align-items: center;
    gap: 0.25rem;
}

/* 动画效果 */
.spinner-dot {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

/* 响应式 */
@media (max-width: 768px) {
    .steps-grid {
        grid-template-columns: 1fr;
    }
    
    .task-meta {
        grid-template-columns: 1fr;
    }
    
    .task-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 1rem;
    }
    
    .task-actions {
        width: 100%;
    }
}
</style>

<script>
let currentFilter = 'all';
let currentTasks = []; // 保存当前任务列表

// 页面加载时获取任务列表
document.addEventListener('DOMContentLoaded', function() {
    loadTasks();
    
    // 每5秒自动刷新
    setInterval(loadTasks, 5000);
});

// 加载任务列表
async function loadTasks() {
    const container = document.getElementById('tasks-container');
    const emptyState = document.getElementById('empty-state');
    
    try {
        const response = await fetch('/api/tasks');
        const result = await response.json();

        if (!result.success) {
            return;
        }

        const tasks = result.data || [];
        currentTasks = tasks; // 保存任务列表
        
        // 更新统计
        updateStats(tasks);

        if (tasks.length === 0) {
            container.innerHTML = '';
            emptyState.style.display = 'block';
            return;
        }

        emptyState.style.display = 'none';
        
        // 过滤任务
        const filteredTasks = currentFilter === 'all' 
            ? tasks 
            : tasks.filter(t => t.status === currentFilter);
        
        // 渲染任务列表
        container.innerHTML = '';
        filteredTasks.forEach(task => {
            const card = createTaskCard(task);
            container.appendChild(card);
        });

    } catch (err) {
        console.error('加载任务列表失败:', err);
    }
}

// 更新统计数据
function updateStats(tasks) {
    const stats = {
        total: tasks.length,
        running: tasks.filter(t => t.status === 'running').length,
        success: tasks.filter(t => t.status === 'success').length,
        failed: tasks.filter(t => t.status === 'failed').length
    };
    
    document.getElementById('stat-total').textContent = stats.total;
    document.getElementById('stat-running').textContent = stats.running;
    document.getElementById('stat-success').textContent = stats.success;
    document.getElementById('stat-failed').textContent = stats.failed;
}

// 创建任务卡片
function createTaskCard(task) {
    const card = document.createElement('div');
    card.className = 'task-card';
    card.dataset.taskId = task.id;
    card.dataset.status = task.status;

    // 计算进度百分比
    const completedSteps = task.steps.filter(s => s.status === 'completed').length;
    const progressPercent = Math.round((completedSteps / task.steps.length) * 100);

    // 状态配置
    const statusConfig = {
        pending: { icon: 'bi-clock', text: '等待中', color: 'pending' },
        running: { icon: 'bi-play-circle-fill', text: '进行中', color: 'running' },
        paused: { icon: 'bi-pause-circle', text: '已暂停', color: 'paused' },
        success: { icon: 'bi-check-circle-fill', text: '成功', color: 'success' },
        failed: { icon: 'bi-x-circle-fill', text: '失败', color: 'failed' },
        cancelled: { icon: 'bi-slash-circle', text: '已取消', color: 'cancelled' }
    };

    const status = statusConfig[task.status] || statusConfig.pending;
    
    // 模式显示名称
    const modeNames = {
        'normal': '正常打包',
        'changelog_only': '仅Changelog',
        'crp_only': '仅CRP打包'
    };

    card.innerHTML = `
        <!-- 任务头部 -->
        <div class="task-header">
            <div class="task-title-section">
                <h3 class="task-project-name">
                    <i class="bi bi-box-seam"></i>
                    ${task.project_name}
                </h3>
                <span class="task-version">v${task.version}</span>
                <span class="task-mode-badge">${modeNames[task.mode] || task.mode}</span>
            </div>
            <div class="task-status-section">
                <span class="task-status-badge status-${status.color}">
                    <i class="bi ${status.icon}"></i>
                    ${status.text}
                </span>
                <span class="text-muted small">#${task.id}</span>
            </div>
        </div>

        <!-- 任务主体 -->
        <div class="task-body">
            ${task.error ? createErrorSection(task.error) : ''}
            
            <!-- 进度条 -->
            <div class="task-progress-text">
                <i class="bi bi-graph-up"></i>
                <span>执行进度: ${progressPercent}% (${completedSteps}/${task.steps.length})</span>
            </div>
            <div class="task-progress-bar">
                <div class="task-progress-fill" style="width: ${progressPercent}%"></div>
            </div>

            <!-- 步骤网格 -->
            <div class="steps-grid">
                ${task.steps.map((step, index) => createStepItem(step, index)).join('')}
            </div>

            <!-- 任务元信息 -->
            <div class="task-meta">
                <div class="meta-item">
                    <i class="bi bi-calendar-plus"></i>
                    <span>创建: ${task.created_at}</span>
                </div>
                ${task.started_at ? `
                <div class="meta-item">
                    <i class="bi bi-play-fill"></i>
                    <span>开始: ${task.started_at}</span>
                </div>
                ` : ''}
                ${task.completed_at ? `
                <div class="meta-item">
                    <i class="bi bi-check-lg"></i>
                    <span>完成: ${task.completed_at}</span>
                </div>
                ` : ''}
                <div class="meta-item">
                    <i class="bi bi-arrow-clockwise"></i>
                    <span>更新: ${task.updated_at}</span>
                </div>
                ${task.architectures ? `
                <div class="meta-item">
                    <i class="bi bi-cpu"></i>
                    <span>架构: ${task.architectures.join(', ')}</span>
                </div>
                ` : ''}
                ${task.github_pr_url ? `
                <div class="meta-item">
                    <i class="bi bi-github"></i>
                    <a href="${task.github_pr_url}" target="_blank" class="text-decoration-none">
                        PR #${task.github_pr_number}
                    </a>
                </div>
                ` : ''}
                ${task.crp_build_url ? `
                <div class="meta-item">
                    <i class="bi bi-box"></i>
                    <a href="${task.crp_build_url}" target="_blank" class="text-decoration-none">
                        CRP构建
                    </a>
                </div>
                ` : ''}
            </div>

            <!-- 操作按钮 -->
            <div class="task-actions">
                ${createActionButtons(task)}
            </div>
        </div>
    `;

    return card;
}

// 创建错误信息区域
function createErrorSection(error) {
    return `
        <div class="error-message">
            <i class="bi bi-exclamation-triangle-fill"></i>
            <div class="error-content">
                <div class="error-title">任务执行失败</div>
                <div class="error-text">${error}</div>
            </div>
        </div>
    `;
}

// 创建步骤项
function createStepItem(step, index) {
    const statusClass = step.status || 'pending';
    const iconMap = {
        pending: 'bi-hourglass',
        running: 'bi-arrow-repeat spinner-dot',
        completed: 'bi-check-lg',
        failed: 'bi-x-lg',
        skipped: 'bi-dash-lg'
    };

    const statusText = {
        pending: '等待',
        running: '执行中',
        completed: '完成',
        failed: '失败',
        skipped: '跳过'
    };

    return `
        <div class="step-item ${statusClass}">
            <div class="step-header">
                <div class="step-icon">
                    <i class="bi ${iconMap[statusClass] || iconMap.pending}"></i>
                </div>
                <div class="step-name">${index + 1}. ${step.name}</div>
            </div>
            ${step.time ? `<div class="step-time">${step.time}</div>` : ''}
            ${step.log_message ? `<div class="step-log">${step.log_message}</div>` : ''}
            ${step.error_message ? `<div class="step-log"style="color: #dc3545;">${step.error_message}</div>` : ''}
        </div>
    `;
}

// 创建操作按钮
function createActionButtons(task) {
    const buttons = [];
    
    // 根据任务状态显示不同按钮
    if (task.status === 'running') {
        buttons.push(`
            <button class="btn btn-sm btn-warning" onclick="pauseTask(${task.id})">
                <i class="bi bi-pause-fill"></i> 暂停
            </button>
        `);
    } else if (task.status === 'paused') {
        buttons.push(`
            <button class="btn btn-sm btn-success" onclick="resumeTask(${task.id})">
                <i class="bi bi-play-fill"></i> 继续
            </button>
        `);
        buttons.push(`
            <button class="btn btn-sm btn-primary" onclick="retryTask(${task.id})">
                <i class="bi bi-arrow-clockwise"></i> 重试
            </button>
        `);
    } else if (task.status === 'failed' || task.status === 'cancelled') {
        // 失败或取消的任务显示重试和重新开始按钮
        buttons.push(`
            <button class="btn btn-sm btn-warning" onclick="retryTask(${task.id})">
                <i class="bi bi-arrow-clockwise"></i> 重试当前步骤
            </button>
        `);
        buttons.push(`
            <button class="btn btn-sm btn-primary" onclick="restartTask(${task.id})">
                <i class="bi bi-arrow-repeat"></i> 重新开始
            </button>
        `);
    }
    
    // 通用按钮
    buttons.push(`
        <button class="btn btn-sm btn-outline-secondary" onclick="viewTaskDetail(${task.id})">
            <i class="bi bi-eye"></i> 详情
        </button>
    `);
    
    if (task.status !== 'success' && task.status !== 'cancelled') {
        buttons.push(`
            <button class="btn btn-sm btn-outline-danger" onclick="cancelTask(${task.id})">
                <i class="bi bi-x-circle"></i> 取消
            </button>
        `);
    }
    
    // 删除按钮 - 运行中的任务不可删除
    if (task.status === 'running') {
        buttons.push(`
            <button class="btn btn-sm btn-outline-danger" disabled title="运行中的任务不能删除">
                <i class="bi bi-trash"></i> 删除
            </button>
        `);
    } else {
        buttons.push(`
            <button class="btn btn-sm btn-outline-danger" onclick="deleteTask(${task.id})">
                <i class="bi bi-trash"></i> 删除
            </button>
        `);
    }
    
    return buttons.join('');
}

// 刷新任务列表
function refreshTasks() {
    loadTasks();
}

// 筛选任务
function filterTasks(status) {
    currentFilter = status;
    
    // 更新按钮状态
    document.querySelectorAll('.btn-group .btn').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
    
    loadTasks();
}

// 查看任务详情
function viewTaskDetail(taskId) {
    // TODO: 显示详细模态框
    alert(`查看任务 #${taskId} 详情\n（功能待实现）`);
}

// 重试任务（从失败步骤继续）
async function retryTask(taskId) {
    // 获取任务数据以确定失败步骤
    const task = currentTasks.find(t => t.id === taskId);
    const failedStep = task ? task.current_step : null;
    
    const stepInfo = failedStep !== null ? `从步骤 ${failedStep} 继续执行` : `继续执行`;
    const confirmed = await customConfirm(
        `将${stepInfo}，失败的步骤会被重新执行。`,
        `重试任务 #${taskId}`,
        'arrow-repeat',
        'primary'
    );
    
    if (confirmed) {
        // 从失败的步骤继续（传递当前步骤号）
        const url = failedStep !== null 
            ? `/api/tasks/${taskId}/retry?from_step=${failedStep}`
            : `/api/tasks/${taskId}/retry`;
            
        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(err => {
                    throw new Error(err.error || '重试失败');
                });
            }
            return response.json();
        })
        .then(data => {
            console.log('任务已重试:', data);
            // 刷新任务列表
            loadTasks();
        })
        .catch(error => {
            console.error('重试任务失败:', error);
            alert(`重试任务失败：${error.message}`);
        });
    }
}

// 重新开始任务（从第一步开始）
async function restartTask(taskId) {
    const confirmed = await customConfirm(
        `将从第一步重新执行整个流程，所有步骤都会被重置。`,
        `重新开始任务 #${taskId}`,
        'arrow-clockwise',
        'danger'
    );
    
    if (confirmed) {
        fetch(`/api/tasks/${taskId}/retry?from_step=0`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ from_step: 0 })
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(err => {
                    throw new Error(err.error || '重新开始失败');
                });
            }
            return response.json();
        })
        .then(data => {
            console.log('任务已从头开始:', data);
            // 刷新任务列表
            loadTasks();
        })
        .catch(error => {
            console.error('重新开始任务失败:', error);
            alert(`重新开始任务失败：${error.message}`);
        });
    }
}

// 暂停任务
async function pauseTask(taskId) {
    const confirmed = await customConfirm(
        `任务将被暂停，可以稍后继续执行。`,
        `暂停任务 #${taskId}`,
        'pause-circle',
        'warning'
    );
    
    if (confirmed) {
        fetch(`/api/tasks/${taskId}/pause`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(err => {
                    throw new Error(err.error || '暂停失败');
                });
            }
            return response.json();
        })
        .then(data => {
            console.log('任务已暂停:', data);
            loadTasks();
        })
        .catch(error => {
            console.error('暂停任务失败:', error);
            alert(`暂停任务失败：${error.message}`);
        });
    }
}


// 取消任务
async function cancelTask(taskId) {
    const confirmed = await customConfirm(
        `任务将被标记为已取消状态，可以重新执行。`,
        `取消任务 #${taskId}`,
        'x-circle',
        'danger'
    );
    
    if (confirmed) {
        fetch(`/api/tasks/${taskId}/cancel`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(err => {
                    throw new Error(err.error || '取消失败');
                });
            }
            return response.json();
        })
        .then(data => {
            console.log('任务已取消:', data);
            // 刷新任务列表
            loadTasks();
        })
        .catch(error => {
            console.error('取消任务失败:', error);
            alert(`取消任务失败：${error.message}`);
        });
    }
}

// 删除任务
async function deleteTask(taskId) {
    const confirmed = await customConfirm(
        `任务及其所有步骤记录将被永久删除，此操作不可恢复。`,
        `删除任务 #${taskId}`,
        'trash',
        'danger'
    );
    
    if (confirmed) {
        fetch(`/api/tasks/${taskId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(err => {
                    throw new Error(err.error || '删除失败');
                });
            }
            return response.json();
        })
        .then(data => {
            showToast('任务已成功删除', 'success');
            loadTasks();
        })
        .catch(error => {
            console.error('删除任务失败:', error);
            showToast(`删除任务失败：${error.message}`, 'error');
        });
    }
}

// 批量清理已完成的任务
async function cleanupCompletedTasks() {
    const confirmed = await customConfirm(
        `将删除所有已完成（成功、失败、取消）的任务，此操作不可恢复。`,
        `清理已完成任务`,
        'trash',
        'danger'
    );
    
    if (confirmed) {
        fetch('/api/tasks/cleanup-completed', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(err => {
                    throw new Error(err.error || '清理失败');
                });
            }
            return response.json();
        })
        .then(data => {
            showToast(`已清理 ${data.deleted_count} 个已完成的任务`, 'success');
            loadTasks();
        })
        .catch(error => {
            console.error('清理任务失败:', error);
            showToast(`清理任务失败：${error.message}`, 'error');
        });
    }
}

</script>
{% endblock %}